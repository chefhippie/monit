# Generated by Chef for <%= node["fqdn"] %>
set daemon <%= @interval %> with start delay <%= @delay %>

set logfile <%= @log_file %>
set idfile <%= @id_file %>
set statefile <%= @state_file %>
set pidfile <%= @pid_file %>

<% @alerts.each do |alert| -%>
set alert <%= alert %>
<% end -%>

set mailserver <%= @mailservers.join(", ") %>

set eventqueue
  basedir <%= @events_dir %>
  slots <%= @slots %>
<%- if @mmonit.enabled -%>

set mmonit <%= @mmonit.host %><% if @mmonit.without_creds -%>
  and register without credentials<%- end -%>
<%- end -%>
<%- if @webinterface.enabled -%>

set httpd port <%= @webinterface.port %> and
  use address <%= @webinterface.listen %>
  <%- @webinterface.allows.each do |allow| -%>
  allow <%= allow %>
  <%- end -%>
<%- end -%>

set mail-format {
  from: monit@<%= node["fqdn"] %>
  reply-to: <%= @reply %>
  subject: <%= @subject %>
  message: <%= @message %>
}

check system <%= node["fqdn"] %>
  <%- if @load.enabled -%>if loadavg(1min) > <%= @load.value %> for <%= @load.cycles %> cycles then alert
  if loadavg(5min) > <%= @load.value / 2 %> for <%= @load.cycles %> cycles then alert<%- end -%>
  <%- if @cpu.enabled -%>if cpu(user) > <%= @cpu.value %>% for <%= @cpu.cycles %> cycles then alert
  if cpu(system) > <%= @cpu.value / 2 %>% for <%= @cpu.cycles %> cycles then alert<%- end -%>
  <%- if @memory.enabled -%>if memory > <%= @memory.value %>% for <%= @memory.cycles %> cycles then alert<%- end -%>
  <%- if @swap.enabled -%>if swap > <%= @swap.value %>% for <%= @swap.cycles %> cycles then alert<%- end -%>

include <%= @config_dir %>/*
